version: '3.4'

services:
  # sql.data:
  #   environment:
  #     - SA_PASSWORD=Pass@word
  #     - ACCEPT_EULA=Y
  #   ports:
  #     - "1433:1433"
  sql.data:
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=Pass@word
    ports:
      - "5432:5432"
    # volumes:
    #  - ./volumes/postgresql/data:/var/lib/postgresql/data

  nosql.redis.data:
    ports:
      - "6379:6379"
  nosql.mongo.data:
    ports:
      - "27017:27017" 
  rabbitmq:
    ports:
      - "15672:15672"
      - "5672:5672"
  consul:
    ports:
      - "8500:8500"
      - "8600:8600"
  influxdb:
    ports:
      - "8086:8086"
      - "8083:8083"
    environment:
      - INFLUXDB_DB=TogetherAppMetricsDB
      - INFLUXDB_ADMIN_ENABLED=true
      - INFLUXDB_ADMIN_USER=admin
      - INFLUXDB_ADMIN_PASSWORD=admin
  grafana:
    ports:
      - "3000:3000"
    # environment:
    #   - GF_SECURITY_ADMIN_PASSWORD=secret

  elasticsearch:
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      - discovery.type=single-node

  identity.api:
    ports:
      - "5000:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - MvcClientUrl=http://${EXTERNAL_DNS_NAME_OR_IP}:5001
      - ManagePortalUrl=http://${EXTERNAL_DNS_NAME_OR_IP}:8001
      - ActivityApiUrl=http://${EXTERNAL_DNS_NAME_OR_IP}:5100
      - NoticeDashboard=http://${EXTERNAL_DNS_NAME_OR_IP}:5104

  activity.api:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionString=Host=sql.data;Port=5432;Database=Together.ActivityDb;User ID=postgres;Password=Pass@word;Pooling=true;
      - IdentityUrl=http://${EXTERNAL_DNS_NAME_OR_IP}:5000
      - ServiceRegisterUrl=http://activity.api:80
      - HealthCheckUrl=http://activity.api/HealthCheck
    ports:
      - "5100:80"


  location.api:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConsulHttpEndpoint=http://consul:8500
      - ServiceRegisterUrl=http://location.api:80
      - HealthCheckUrl=http://location.api/HealthCheck
    ports:
      - "5106:80"


  usergroup.api:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ServiceRegisterUrl=http://usergroup.api:80
      - HealthCheckUrl=http://usergroup.api/HealthCheck
    ports:
      - "5105:80"


  webmvc:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80;http://+:443
      - IdentityUrl=http://${EXTERNAL_DNS_NAME_OR_IP}:5000
      - APIGatewayEndpoint=http://${EXTERNAL_DNS_NAME_OR_IP}:8000
      - NoticeHttpEndpoint=http://${EXTERNAL_DNS_NAME_OR_IP}:5104
    ports:
      - "5001:80"
      - "5002:443"
    volumes:
      - ${APPDATA}/ASP.NET/Https:/root/.aspnet/https:ro
      - ${APPDATA}/Microsoft/UserSecrets:/root/.microsoft/usersecrets:ro

  api.gateway:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - IdentityUrl=http://${EXTERNAL_DNS_NAME_OR_IP}:5000
    ports:
      - "8000:80"

  noticeservice:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - RedisConnectionString=nosql.redis.data:6379
      - IdentityUrl=http://${EXTERNAL_DNS_NAME_OR_IP}:5000
    ports:
      - "5104:80"
  activity.backgroundtasks:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
    ports:
      - "5101:80"
    volumes:
      - ${APPDATA}/ASP.NET/Https:/root/.aspnet/https:ro
      - ${APPDATA}/Microsoft/UserSecrets:/root/.microsoft/usersecrets:ro
 
  manageportal:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - IdentityUrl=http://${EXTERNAL_DNS_NAME_OR_IP}:5000
      - APIGatewayEndpoint=http://${EXTERNAL_DNS_NAME_OR_IP}:8000
      - NoticeHttpEndpoint=http://${EXTERNAL_DNS_NAME_OR_IP}:5104
    ports:
      - "8001:80"

  searching.api:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - RabbitmqHost=rabbitmq
      - ElasticSearchUrl=http://elasticsearch:9200
      - ConnectionString=Host=sql.data;Port=5432;Database=Together.Searching;Persist Security Info=True;User ID=postgres;Password=Pass@word;Pooling=true;
    ports:
      - "5555:80"